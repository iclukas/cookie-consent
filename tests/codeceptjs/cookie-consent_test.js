/* global Feature Scenario */

const assert = require('assert')
const waitTime = 3

Feature('Cookie Consent')

Scenario('should work correctly', async function (I) {
  // initial state
  I.amOnPage('cookie-consent.html')
  // I.wait(waitTime)
  I.dontSeeCookie('cookie_consent_status')
  I.dontSeeCookie('_ga')
  I.dontSeeCookie('_gat')
  I.dontSeeCookie('_gid')
  I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('[data-cc-consent="statistics"]')
  I.seeElement('[data-cc-consent="extern-media"]')
  I.seeElement('.cookie-consent-save')
  I.dontSeeCheckboxIsChecked('[data-cc-consent="statistics"]')
  I.dontSeeCheckboxIsChecked('[data-cc-consent="extern-media"]')

  // allow single consents
  I.checkOption('[data-cc-consent="statistics"]')
  I.checkOption('[data-cc-consent="extern-media"]')
  I.click('.cookie-consent-save')
  I.seeCookie('cookie_consent_status')
  I.seeCookie('_ga')
  I.seeCookie('_gat')
  I.seeCookie('_gid')
  let cookie = await I.grabCookie('cookie_consent_status')
  assert.deepStrictEqual(cookie.value, '["statistics","extern-media"]')

  // dissallow some consents
  I.click('.cookie-consent-open')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('[data-cc-consent="statistics"]')
  I.seeElement('[data-cc-consent="extern-media"]')
  I.seeElement('.cookie-consent-save')
  I.seeCheckboxIsChecked('[data-cc-consent="statistics"]')
  I.seeCheckboxIsChecked('[data-cc-consent="extern-media"]')
  I.uncheckOption('[data-cc-consent="statistics"]')
  I.uncheckOption('[data-cc-consent="extern-media"]')
  I.click('.cookie-consent-save')
  I.seeCookie('cookie_consent_status')
  I.dontSeeCookie('_ga')
  I.dontSeeCookie('_gat')
  I.dontSeeCookie('_gid')
  cookie = await I.grabCookie('cookie_consent_status')
  assert.deepStrictEqual(cookie.value, '[]')
  I.click('.cookie-consent-open')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('[data-cc-consent="statistics"]')
  I.seeElement('[data-cc-consent="extern-media"]')
  I.seeElement('.cookie-consent-save')
  I.dontSeeCheckboxIsChecked('[data-cc-consent="statistics"]')
  I.dontSeeCheckboxIsChecked('[data-cc-consent="extern-media"]')

  // open and close buttons
  I.click('.cookie-consent-close')
  // I.wait(waitTime)
  I.dontSeeElement('.cookie-consent-popup')
  I.dontSeeElement('[data-cc-consent="statistics"]')
  I.dontSeeElement('[data-cc-consent="extern-media"]')
  I.dontSeeElement('.cookie-consent-save')
  I.click('.cookie-consent-controls-open')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('[data-cc-consent="statistics"]')
  I.seeElement('[data-cc-consent="extern-media"]')
  I.seeElement('.cookie-consent-save')
  I.click('.cookie-consent-controls-close')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.dontSeeElement('[data-cc-consent="statistics"]')
  I.dontSeeElement('[data-cc-consent="extern-media"]')
  I.dontSeeElement('.cookie-consent-save')
  I.click('.cookie-consent-details-open')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('.cookie-consent-details')
  I.click('.cookie-consent-details-close')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.dontSeeElement('.cookie-consent-details')

  // toggle buttons
  I.click('.cookie-consent-close')
  I.click('.cookie-consent-controls-close')
  I.click('.cookie-consent-details-close')
  // I.wait(waitTime)
  I.dontSeeElement('.cookie-consent-popup')
  I.dontSeeElement('.cookie-consent-controls')
  I.dontSeeElement('.cookie-consent-details')
  I.click('.cookie-consent-toggle')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.click('.cookie-consent-toggle')
  // I.wait(waitTime)
  I.dontSeeElement('.cookie-consent-popup')

  // control toggle buttons
  I.click('.cookie-consent-close')
  I.click('.cookie-consent-controls-toggle')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('.cookie-consent-controls')
  I.click('.cookie-consent-controls-toggle')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.dontSeeElement('.cookie-consent-controls')

  // details toggle buttons
  I.click('.cookie-consent-close')
  I.click('.cookie-consent-details-toggle')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('.cookie-consent-details')
  I.click('.cookie-consent-details-toggle')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.dontSeeElement('.cookie-consent-details')

  // accept all
  I.click('.cookie-consent-accept-all')
  I.seeCookie('cookie_consent_status')
  I.seeCookie('_ga')
  I.seeCookie('_gat')
  I.seeCookie('_gid')
  cookie = await I.grabCookie('cookie_consent_status')
  assert.deepStrictEqual(cookie.value, '["statistics","extern-media"]')
  I.click('.cookie-consent-open')
  // I.wait(waitTime)
  I.seeElement('.cookie-consent-popup')
  I.seeElement('[data-cc-consent="statistics"]')
  I.seeElement('[data-cc-consent="extern-media"]')
  I.seeElement('.cookie-consent-save')

  // deny all
  I.click('.cookie-consent-deny-all')
  // I.wait(waitTime)
  I.seeCookie('cookie_consent_status')
  I.dontSeeCookie('_ga')
  I.dontSeeCookie('_gat')
  I.dontSeeCookie('_gid')
  cookie = await I.grabCookie('cookie_consent_status')
  assert.deepStrictEqual(cookie.value, '[]')
})
